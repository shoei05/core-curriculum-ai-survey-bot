# Claude-GLM → Codex 自動レビュー連携システム 仕様書

## 1. 概要

Claude Code（claude-glm）がファイルを編集した際に、**同期的に**Codexがレビューを実行し、結果をclaude-glmにフィードバックするシステム。

### 目的
- 実装役（Claude-GLM）とレビュー役（Codex）の自動連携
- コード品質の即時フィードバック
- 人手を介さない継続的レビュープロセス

## 2. アーキテクチャ

```
┌─────────────────┐
│  Claude-GLM     │
│  (実装役)        │
└────────┬────────┘
         │ Write/Edit ツール実行
         ↓
┌─────────────────┐     同期実行            ┌─────────────────┐
│  PostToolUse    │ ──────────────────────→ │  Codex CLI      │
│  Hook           │ ←────────────────────── │  (レビュー役)    │
└────────┬────────┘     レビュー結果         └─────────────────┘
         │
         ↓ フィードバック（hook output）
┌─────────────────┐
│  Claude-GLM     │  ← レビュー結果を受け取り、必要なら修正
│  (次のアクション) │
└─────────────────┘
```

## 3. システム構成

### 3.1 ディレクトリ構造

```
~/.claude/
├── scripts/
│   └── codex-review.sh     # レビュートリガースクリプト (chmod +x)
├── reviews/
│   ├── latest.md           # 最新レビュー（シンボリックリンク）
│   └── review_*.md         # レビュー履歴
└── settings.json           # Claude Code hooks設定
```

### 3.2 コンポーネント

| コンポーネント | 役割 |
|---------------|------|
| `codex-review.sh` | PostToolUse hookから呼ばれ、Codexにレビューを依頼 |
| `settings.json` | hook設定を管理 |
| `reviews/` | レビュー履歴を保存 |

## 4. 実装ファイル

### 4.1 レビュースクリプト

**ファイル**: `~/.claude/scripts/codex-review.sh`

```bash
#!/bin/bash
# PostToolUse hookから同期的に呼ばれるスクリプト

TOOL_NAME="$CLAUDE_TOOL_NAME"
FILE_PATH="$CLAUDE_FILE_PATH"
REVIEW_DIR="$HOME/.claude/reviews"

# Write/Editツール以外は無視
if [[ "$TOOL_NAME" != "Write" && "$TOOL_NAME" != "Edit" ]]; then
  exit 0
fi

# ファイルが存在しない場合は終了
if [[ ! -f "$FILE_PATH" ]]; then
  exit 0
fi

# 特定の拡張子のみレビュー対象
case "$FILE_PATH" in
  *.ts|*.tsx|*.js|*.jsx|*.py|*.go|*.rs|*.sh|*.md)
    ;;
  *)
    exit 0
    ;;
esac

# レビューディレクトリ作成
mkdir -p "$REVIEW_DIR"
TIMESTAMP=$(date +%Y%m%d_%H%M%S)
REVIEW_FILE="$REVIEW_DIR/review_${TIMESTAMP}.md"

# ファイル内容取得
FILE_CONTENT=$(cat "$FILE_PATH")

# Codex CLIでレビュー実行（同期）
REVIEW_PROMPT="以下のコードをレビューしてください。

ファイル: $FILE_PATH

\`\`\`
$FILE_CONTENT
\`\`\`

レビュー観点:
1. バグや論理エラー
2. セキュリティ上の問題
3. パフォーマンス改善点
4. コード品質・可読性

問題がなければ「LGTM」とだけ回答してください。"

# Codex実行（非インタラクティブ）
REVIEW_RESULT=$(echo "$REVIEW_PROMPT" | codex --quiet 2>&1)

# 結果をファイルに保存
{
  echo "# Codex Review: $(basename "$FILE_PATH")"
  echo "- File: $FILE_PATH"
  echo "- Time: $(date)"
  echo ""
  echo "## Review Result"
  echo "$REVIEW_RESULT"
} > "$REVIEW_FILE"

# 最新レビューへのリンク更新
ln -sf "$REVIEW_FILE" "$REVIEW_DIR/latest.md"

# 標準出力にサマリーを出力（hookのフィードバックとして表示される）
echo ""
echo "=== Codex Review Feedback ==="
echo "$REVIEW_RESULT"
echo "============================="
```

### 4.2 hooks設定

**ファイル**: `~/.claude/settings.json` に追加

```json
{
  "hooks": {
    "PostToolUse": [
      {
        "matcher": "Write|Edit",
        "hooks": [
          {
            "type": "command",
            "command": "~/.claude/scripts/codex-review.sh",
            "timeout": 120000
          }
        ]
      }
    ]
  }
}
```

## 5. 環境変数

PostToolUse hookで利用可能な環境変数:

| 変数名 | 説明 |
|--------|------|
| `CLAUDE_TOOL_NAME` | 実行されたツール名（Write, Edit等） |
| `CLAUDE_FILE_PATH` | 操作対象のファイルパス |
| `CLAUDE_TOOL_INPUT` | ツールへの入力（JSON形式） |

## 6. 実装手順

1. `~/.claude/scripts/` ディレクトリ作成
   ```bash
   mkdir -p ~/.claude/scripts
   ```

2. `codex-review.sh` スクリプト作成
   ```bash
   # 上記スクリプトを ~/.claude/scripts/codex-review.sh に保存
   ```

3. スクリプトに実行権限付与
   ```bash
   chmod +x ~/.claude/scripts/codex-review.sh
   ```

4. `~/.claude/reviews/` ディレクトリ作成
   ```bash
   mkdir -p ~/.claude/reviews
   ```

5. `~/.claude/settings.json` にPostToolUse hook追加

6. Claude Codeを再起動して設定反映

7. テストファイル編集で動作確認

## 7. 検証方法

1. claude-glmで簡単なファイルを作成:
   ```
   test.py に hello world を書いて
   ```

2. 編集完了後、自動的にCodexレビューが実行されることを確認

3. レビュー結果がclaude-glmのターミナルに表示されることを確認

4. `~/.claude/reviews/latest.md` に結果が保存されていることを確認

## 8. 前提条件

- Codex CLIがインストール済みで、`codex`コマンドがPATHに通っていること
  ```bash
  which codex  # パスが表示されることを確認
  ```

- Claude Code（claude-glm）がインストール済みであること

## 9. 設定パラメータ

| パラメータ | 値 | 説明 |
|-----------|-----|------|
| タイムアウト | 120000ms (2分) | 大きなファイルの場合は調整 |
| レビュー対象拡張子 | ts, tsx, js, jsx, py, go, rs, sh, md | スクリプト内で変更可能 |

## 10. 拡張オプション

- レビュー結果に問題がある場合のみサウンド通知
- 特定ディレクトリのみレビュー対象にするフィルタ
- レビュー結果をGitHub PRコメントとして自動投稿
- レビュー履歴のローテーション（古いファイルの自動削除）
